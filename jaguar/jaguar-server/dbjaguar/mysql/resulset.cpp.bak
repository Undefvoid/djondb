#include "mysql.h"

using namespace dbjaguar;

MYSQL_FIELD** m_res_fields;
int m_res_numfields;

MySQLResultSet::MySQLResultSet(MYSQL_RES* res, const char* query)
{
    m_res = res;
    m_query = query;

    m_res_numfields = mysql_num_fields(res);
    m_res_fields = (MYSQL_FIELD**)malloc(sizeof(MYSQL_FIELD)*m_res_numfields);
    for (int i = 0; i < m_res_numfields; i++)
    {
        MYSQL_FIELD* field = mysql_fetch_field(res);
        m_res_fields[i] = field;
    }
};

bool MySQLResultSet::next() throw (DBException)
{
    m_currentRow = mysql_fetch_row(m_res);
    if (m_currentRow) {
        return true;
    } else {
        return false;
    }
};

bool MySQLResultSet::previous() throw (DBException)
{
    return true;
};

void MySQLResultSet::close() throw (DBException)
{
    while ((m_currentRow = mysql_fetch_row(m_res)));

    mysql_free_result(m_res);
    free(m_res_fields);
}

void* MySQLResultSet::get(int col) throw (DBException)
{
    char* value = (char*)m_currentRow[col];
    MYSQL_FIELD* field = m_res_fields[col];
    switch (field->type) {
        case MYSQL_TYPE_BIT: {
            int ivalue = atoi(value);
            bool* bres;
            *bres =(ivalue == 1)? true:false;
            return bres;
        }
        case MYSQL_TYPE_BLOB:
            break;
        case MYSQL_TYPE_DATE:
            break;
        case MYSQL_TYPE_DATETIME:
            break;
        case MYSQL_TYPE_DECIMAL:
            break;
        case MYSQL_TYPE_DOUBLE:
            break;
        case MYSQL_TYPE_ENUM:
            break;
        case MYSQL_TYPE_FLOAT:
            break;
        case MYSQL_TYPE_GEOMETRY:
            break;
        case MYSQL_TYPE_INT24: {
            break;
        }
        case MYSQL_TYPE_LONG:
            break;
        case MYSQL_TYPE_LONGLONG:
            break;
        case MYSQL_TYPE_LONG_BLOB:
            break;
        case MYSQL_TYPE_MEDIUM_BLOB:
            break;
        case MYSQL_TYPE_NEWDATE:
            break;
        case MYSQL_TYPE_NEWDECIMAL:
            break;
        case MYSQL_TYPE_NULL:
            break;
        case MYSQL_TYPE_SET:
            break;
        case MYSQL_TYPE_SHORT:
            break;
        case MYSQL_TYPE_STRING:
            return new string(m_currentRow[col]);
            break;
        case MYSQL_TYPE_TIME:
            break;
        case MYSQL_TYPE_TIMESTAMP:
            break;
        case MYSQL_TYPE_TINY:
            break;
        case MYSQL_TYPE_TINY_BLOB:
            break;
        case MYSQL_TYPE_VARCHAR:
            return value;
            break;
        case MYSQL_TYPE_VAR_STRING:
            break;
        case MYSQL_TYPE_YEAR:
            break;
    }
    return value;
}

void* MySQLResultSet::get(const char* colname) throw (DBException)
{
    return NULL;
}

